<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-app.js";
    import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAgaXEJG4OcAxfD2-B5H8ZjV6DOohh0Iu8",
        authDomain: "online-bus-ticket-afcfb.firebaseapp.com",
        databaseURL: "https://online-bus-ticket-afcfb-default-rtdb.firebaseio.com",
        projectId: "online-bus-ticket-afcfb",
        storageBucket: "online-bus-ticket-afcfb.appspot.com",
        messagingSenderId: "652012576413",
        appId: "1:652012576413:web:c512be1f3891d854afbe74",
        measurementId: "G-BNR9Y1VXTE"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const seatContainer = document.getElementById('seatContainer');
    const saveButton = document.getElementById('saveButton');
    const nameInput = document.getElementById('name');
    const phoneInput = document.getElementById('phone');
    const passengerForm = document.getElementById('passengerForm');

    let selectedSeats = [];

    // Generate seats dynamically
    const rows = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J'];
    const cols = ['1', '2', '3', '4'];

    rows.forEach(row => {
        cols.forEach(col => {
            const seat = document.createElement('div');
            seat.classList.add('seat');
            seat.textContent = `${row}${col}`;
            seat.addEventListener('click', () => {
                if (seat.classList.contains('occupied')) {
                    alert('This seat is already occupied!');
                    return;
                }

                if (seat.classList.contains('selected')) {
                    seat.classList.remove('selected');
                    selectedSeats = selectedSeats.filter(s => s !== seat.textContent);
                } else {
                    seat.classList.add('selected');
                    selectedSeats.push(seat.textContent);
                }
                passengerForm.style.display = selectedSeats.length > 0 ? 'block' : 'none';
            });
            seatContainer.appendChild(seat);
        });
    });

    // Initialize seats from Firebase
    function initializeSeats() {
        const seatsRef = ref(db, 'seats');
        onValue(seatsRef, snapshot => {
            const data = snapshot.val();
            if (data) {
                Object.keys(data).forEach(seat => {
                    const seatElement = Array.from(document.querySelectorAll('.seat')).find(s => s.textContent === seat);
                    if (seatElement) {
                        seatElement.classList.add('occupied');
                    }
                });
            }
        });
    }

    saveButton.addEventListener('click', () => {
        const name = nameInput.value;
        const phone = phoneInput.value;

        if (!name || !phone || selectedSeats.length === 0) {
            alert('Please fill out all fields and select seats.');
            return;
        }

        const updates = {};
        selectedSeats.forEach(seat => {
            updates[`seats/${seat}`] = { name, phone };
        });

        // Update Firebase with new bookings
        update(ref(db), updates)
            .then(() => {
                alert('Booking successful!');
                selectedSeats.forEach(seat => {
                    const seatElement = Array.from(document.querySelectorAll('.seat')).find(s => s.textContent === seat);
                    if (seatElement) {
                        seatElement.classList.add('occupied');
                        seatElement.classList.remove('selected');
                    }
                });
                selectedSeats = [];
                nameInput.value = '';
                phoneInput.value = '';
                passengerForm.style.display = 'none';
            })
            .catch(error => {
                alert('Error saving booking: ' + error.message);
            });
    });

    // Initialize seats on page load
    initializeSeats();
</script>
